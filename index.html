// server.js

const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');

const app = express();
const port = 3000; // You can choose any available port

// Middleware
app.use(cors()); // Enable CORS for all routes
app.use(express.json()); // Parse JSON request bodies

// --- MongoDB Connection ---
const mongoURI = 'YOUR_MONGODB_ATLAS_CONNECTION_STRING'; // REPLACE THIS with your connection string
// Example: mongodb+srv://myuser:mypassword@cluster0.abcde.mongodb.net/marioSluggersDB?retryWrites=true&w=majority

mongoose.connect(mongoURI, {
    // useNewUrlParser: true, // Deprecated in Mongoose 6+
    // useUnifiedTopology: true, // Deprecated in Mongoose 6+
})
.then(() => console.log('MongoDB connected successfully!'))
.catch(err => console.error('MongoDB connection error:', err));

// --- Mongoose Schemas and Models ---

// Schema for Standings
const StandingSchema = new mongoose.Schema({
    teamName: { type: String, required: true, unique: true },
    record: { type: String, required: true },
});
const Standing = mongoose.model('Standing', StandingSchema);

// Schema for Draft Board
const DraftBoardSchema = new mongoose.Schema({
    name: { type: String, required: true, unique: true }, // Player Name (e.g., Brian)
    captainCharacter: { type: String, required: true }, // Captain Character (e.g., Bowser Jr.)
    picks: { type: [String], default: Array(8).fill('') }, // Array of 8 strings for drafted players
});
const DraftBoardEntry = mongoose.model('DraftBoardEntry', DraftBoardSchema);

// Schema for Week Schedule
const WeekScheduleSchema = new mongoose.Schema({
    week: { type: String, required: true, unique: true }, // e.g., "Week 1", "Playoffs Round 1"
    matchups: { type: [String], default: [] } // e.g., ["Team A vs Team B", "Team C vs Team D"]
});
const WeekSchedule = mongoose.model('WeekSchedule', WeekScheduleSchema);

// --- API Routes ---

// Standings Routes
app.get('/api/standings', async (req, res) => {
    try {
        const standings = await Standing.find().sort({ teamName: 1 }); // Sort by team name for consistent order
        res.json(standings);
    } catch (err) {
        res.status(500).json({ message: err.message });
    }
});

app.post('/api/standings', async (req, res) => {
    const { teamName, record } = req.body;
    if (!teamName || !record) {
        return res.status(400).json({ message: 'Team Name and Record are required.' });
    }

    try {
        let standing = await Standing.findOne({ teamName });
        if (standing) {
            // Update existing
            standing.record = record;
            await standing.save();
            res.json(standing);
        } else {
            // Create new
            standing = new Standing({ teamName, record });
            await standing.save();
            res.status(201).json(standing);
        }
    } catch (err) {
        res.status(400).json({ message: err.message });
    }
});

app.delete('/api/standings/:teamName', async (req, res) => {
    try {
        const result = await Standing.deleteOne({ teamName: req.params.teamName });
        if (result.deletedCount === 0) {
            return res.status(404).json({ message: 'Standing not found' });
        }
        res.json({ message: 'Standing deleted successfully' });
    } catch (err) {
        res.status(500).json({ message: err.message });
    }
});


// Draft Board Routes
app.get('/api/draftboard', async (req, res) => {
    try {
        const draftBoard = await DraftBoardEntry.find().sort({ name: 1 }); // Sort by player name
        res.json(draftBoard);
    } catch (err) {
        res.status(500).json({ message: err.message });
    }
});

// Initializing draft board entries if they don't exist
// This route can be called once manually or check on server start
app.post('/api/draftboard/initialize', async (req, res) => {
    const draftPlayerNames = ["Brian", "Dylan", "Jacob", "Grant", "Phil", "Cole", "Murph"];
    const captainCharacters = {
        "Brian": "Bowser Jr.", "Dylan": "Diddy Kong", "Jacob": "Donkey Kong",
        "Cole": "Waluigi", "Murph": "Mario", "Phil": "Yoshi", "Grant": "Daisy"
    };

    try {
        for (const playerName of draftPlayerNames) {
            let entry = await DraftBoardEntry.findOne({ name: playerName });
            if (!entry) {
                entry = new DraftBoardEntry({
                    name: playerName,
                    captainCharacter: captainCharacters[playerName] || 'N/A',
                    picks: Array(8).fill('')
                });
                await entry.save();
            } else {
                 // Ensure existing entries have correct captain and pick array length
                 entry.captainCharacter = captainCharacters[playerName] || 'N/A';
                 if (entry.picks.length !== 8) {
                     const newPicks = Array(8).fill('');
                     entry.picks.forEach((pick, index) => {
                         if (index < 8) newPicks[index] = pick;
                     });
                     entry.picks = newPicks;
                 }
                 await entry.save();
            }
        }
        const updatedBoard = await DraftBoardEntry.find().sort({ name: 1 });
        res.status(200).json(updatedBoard);
    } catch (err) {
        res.status(500).json({ message: err.message });
    }
});


app.post('/api/draftboard/pick', async (req, res) => {
    const { playerName, pickNumber, draftedPlayer } = req.body;
    if (!playerName || typeof pickNumber === 'undefined' || !draftedPlayer) {
        return res.status(400).json({ message: 'Player Name, Pick Number, and Drafted Player are required.' });
    }

    try {
        const entry = await DraftBoardEntry.findOne({ name: playerName });
        if (!entry) {
            return res.status(404).json({ message: 'Player not found in draft board.' });
        }

        // Adjust pickNumber to be 0-indexed for array
        if (pickNumber >= 1 && pickNumber <= 8) {
            entry.picks[pickNumber - 1] = draftedPlayer;
            await entry.save();
            res.json(entry);
        } else {
            return res.status(400).json({ message: 'Pick number must be between 1 and 8.' });
        }
    } catch (err) {
        res.status(400).json({ message: err.message });
    }
});

app.delete('/api/draftboard/pick/:playerName/:pickIndex', async (req, res) => {
    const { playerName, pickIndex } = req.params; // pickIndex will be 0-indexed from frontend
    
    try {
        const entry = await DraftBoardEntry.findOne({ name: playerName });
        if (!entry) {
            return res.status(404).json({ message: 'Player not found in draft board.' });
        }

        const index = parseInt(pickIndex, 10);
        if (index >= 0 && index < entry.picks.length) {
            entry.picks[index] = ''; // Clear the pick
            await entry.save();
            res.json({ message: 'Draft pick deleted successfully' });
        } else {
            return res.status(400).json({ message: 'Invalid pick index.' });
        }
    } catch (err) {
        res.status(500).json({ message: err.message });
    }
});

// Week Schedule Routes
app.get('/api/schedule', async (req, res) => {
    try {
        const schedule = await WeekSchedule.find().sort({ week: 1 }); // Sort by week string (might need custom sort later)
        res.json(schedule);
    } catch (err) {
        res.status(500).json({ message: err.message });
    }
});

app.post('/api/schedule', async (req, res) => {
    const { week, matchups } = req.body; // matchups should be an array of strings
    if (!week || !Array.isArray(matchups)) {
        return res.status(400).json({ message: 'Week and Matchups (as array) are required.' });
    }

    try {
        let entry = await WeekSchedule.findOne({ week });
        if (entry) {
            entry.matchups = matchups; // Overwrite existing matchups for that week
            await entry.save();
            res.json(entry);
        } else {
            entry = new WeekSchedule({ week, matchups });
            await entry.save();
            res.status(201).json(entry);
        }
    } catch (err) {
        res.status(400).json({ message: err.message });
    }
});

app.delete('/api/schedule/:week', async (req, res) => {
    try {
        const result = await WeekSchedule.deleteOne({ week: req.params.week });
        if (result.deletedCount === 0) {
            return res.status(404).json({ message: 'Week schedule not found' });
        }
        res.json({ message: 'Week schedule deleted successfully' });
    } catch (err) {
        res.status(500).json({ message: err.message });
    }
});

// Start the server
app.listen(port, () => {
    console.log(`Server running on http://localhost:${port}`);
});
